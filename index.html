<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Factoring App</title>
  </head>
  <body onload="loadFirstProblem()">
    <div id="totalProblemsPassed">0</div>
    <div id="numberToFactor" onclick="clicked()"></div>
    <input type="text" id="factor1">
    <input type="text" id="factor2">
    <button onclick="submitAnswers()">Submit</button>
    <div id="grader"></div>
    <div id="possiblePairs"></div>
    <div id="guessedPairs"></div>
    <button onclick="nextProblem()">Next Problem</button>

    <script>

      var guessedPairs
      var factorPairs
      var totalProblemsPassed

      function loadFirstProblem() {
        totalProblemsPassed = 0
        loadNewProblem()
        cookieTotalProblemsPassed = getCookie('totalProblemsPassed')
        if (cookieTotalProblemsPassed != "") {
          totalProblemsPassed = parseInt(cookieTotalProblemsPassed)
          document.getElementById('totalProblemsPassed').innerHTML = totalProblemsPassed
        }
      }

      function loadNewProblem() {
        resetForNewProblem()
        product = getNumber()
        document.getElementById('numberToFactor').innerHTML = product
        factorPairs = findFactors(product)
        document.getElementById('possiblePairs').innerHTML = factorPairs.length
        guessedPairs = []
      }

      function resetForNewProblem() {
        factorPairs = []
        guessedPairs = []
        document.getElementById('factor1').value = ""
        document.getElementById('factor2').value = ""
        document.getElementById('grader').innerHTML = ""
        document.getElementById('possiblePairs').innerHTML = ""
        document.getElementById('guessedPairs').innerHTML = ""
      }

      function findFactors(product) {
        // Returns array of L2 arrays of factors for product
        var factorPairs = []
        var i;
        for (i = 0; i < (product / 2) + 1; i++) {
          if ((product % i) == 0) {
            newPair = [i, product / i]
            reversedPair = [product / i, i]
            if (!isInArray(newPair, factorPairs)) {
              factorPairs.push([i, (product / i)])
            }
          }
        }
        return factorPairs
      }

      function isInArray(item, array) {
        // Checks if item (an array of length 2) is in array
        console.log("in isInArray with:")
        console.log("item", item, "array", array)
        for (i = 0; i < array.length; i++) {
          if (item[0] == array[i][0] && item[1] == array[i][1] ||
              item[0] == array[i][1] && item[1] == array[i][0]) {
            console.log(item, "is in", array)
            return true
          }
        }
        return false
      }

      function clicked() {
        submitAnswers()
      }

      function getNumber() {
        return getRandomInt(144)
      }

      function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
      }

      function submitAnswers() {
        product = document.getElementById('numberToFactor').textContent
        factor1 = document.getElementById('factor1').value
        factor2 = document.getElementById('factor2').value

        if (isInArray([factor1, factor2], guessedPairs)) {
          document.getElementById('grader').innerHTML = "You already guessed that pair"
          return
        }

        if (checkFactors(product, factor1, factor2)) {
          // Factors 1 and 2 do multiply to Product
          document.getElementById('grader').innerHTML = "correct!"
          guessedPairs.push([factor1, factor2])
          setGuessedPairs(guessedPairs)
        } else {
          // Incorrect factors
          document.getElementById('grader').innerHTML = "try again!"
        }

      }

      function setGuessedPairs(guessedPairs) {
        var pairsString = ""
        for (i = 0; i < guessedPairs.length; i++) {
          pairsString += "<p>"
          pairsString += guessedPairs[i]
          pairsString += "</p>"
        }
        document.getElementById('guessedPairs').innerHTML = pairsString
      }

      function checkFactors(product, factor1, factor2) {
        if ((product / factor1) == factor2) {
          return true
        } else {
          return false
        }
      }

      function nextProblem() {
        if (guessedPairs.length == factorPairs.length) {
          totalProblemsPassed += 1
          setCookie("totalProblemsPassed", totalProblemsPassed, 160)
          document.getElementById('totalProblemsPassed').innerHTML = totalProblemsPassed
        }
        loadNewProblem()
      }

      function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        var expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for(var i = 0; i <ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }


    </script>
  </body>
</html>
